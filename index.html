<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>手寫簽名</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f5f5f5;
        }

        canvas {
            border: 2px solid #333;
            background: #fff;
            touch-action: none; /* 防止手機滑動 */
        }

        .buttons {
            margin-top: 10px;
        }

        button {
            padding: 8px 16px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>請在下方手寫簽名</h2>

<canvas id="signaturePad" width="500" height="200"></canvas>

<div class="buttons">
    <button onclick="clearCanvas()">清除</button>
    <button onclick="saveSignature()">儲存簽名</button>
</div>

<script>
async function sha256Hex(text) {
  const bytes = new TextEncoder().encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", bytes);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function nowString() {
  const d = new Date();
  const pad = n => String(n).padStart(2,'0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function isCanvasBlank(ctx, canvas) {
  const data = ctx.getImageData(0,0,canvas.width,canvas.height).data;
  for (let i=3;i<data.length;i+=4) if (data[i] !== 0) return false;
  return true;
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    alert("已複製完成碼，請回 BeClass 貼上。");
  } catch {
    prompt("請手動複製完成碼，回 BeClass 貼上：", text);
  }
}

async function saveSignature() {
  const agree = document.getElementById('agreeChk'); // 你若有同意勾選
  if (agree && !agree.checked) { alert("請先勾選同意條款"); return; }

  const canvas = document.getElementById('signaturePad');
  const ctx = canvas.getContext('2d');
  if (isCanvasBlank(ctx, canvas)) { alert("尚未簽名，請先手寫簽名"); return; }

  const dataURL = canvas.toDataURL("image/png");
  const t = nowString();
  const hash = await sha256Hex(dataURL);
  const shortHash = hash.slice(0, 16); // 短碼即可（避免太長）

  // 完成碼（你也可自行調整格式）
  const signCode = `SIGNED|${t}|${shortHash}`;

  // 顯示到頁面（需有 #signCodeOutput 元素）
  const out = document.getElementById('signCodeOutput');
  if (out) out.textContent = signCode;

  // 一鍵複製
  await copyText(signCode);
}
</script>


</body>
</html>

<div style="margin-top:12px;background:#fff;border:1px solid #ccc;border-radius:8px;padding:10px;">
  <div style="font-weight:600;">簽名完成碼（請複製貼回 BeClass）</div>
  <div id="signCodeOutput" style="margin-top:6px;word-break:break-all;"></div>
</div>

