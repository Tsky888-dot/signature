<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>æ‰‹å¯«ç°½å</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; text-align:center; }
canvas { border:2px solid #333; background:#fff; touch-action:none; }
button { padding:8px 16px; margin:6px; font-size:15px; cursor:pointer; }
#codeBox {
  display:none; max-width:720px; margin:12px auto;
  background:#fff; border:1px solid #ccc; border-radius:10px;
  padding:12px; text-align:left;
}
#signCodeOutput {
  margin-top:6px; word-break:break-all;
  font-family:Consolas, monospace;
}
</style>
</head>

<body>

<h2>è«‹æ–¼ä¸‹æ–¹æ‰‹å¯«ç°½å</h2>

<div style="max-width:720px;margin:0 auto;text-align:left;">
  <label>
    <input type="checkbox" id="agreeChk">
    æˆ‘å·²é–±è®€ä¸¦åŒæ„ç›¸é—œæ´»å‹•è¦ç¯„èˆ‡æ³¨æ„äº‹é …
  </label>
</div>

<br>

<canvas id="signaturePad" width="500" height="200"></canvas>

<br>

<button onclick="clearCanvas()">æ¸…é™¤é‡ç°½</button>
<button onclick="saveSignature()">å®Œæˆç°½å</button>
<button onclick="uploadSignature()">ä¸Šå‚³ç°½ååœ–ç‰‡åˆ°é›²ç«¯</button>

<div id="codeBox">
  <div style="font-weight:700;">ç°½åå®Œæˆç¢¼ï¼ˆè«‹é»ä¸‹æ–¹æŒ‰éˆ•è¤‡è£½ï¼Œå› BeClass è²¼ä¸Šï¼‰</div>
  <div id="signCodeOutput"></div>
  <div style="margin-top:8px;">
    <button onclick="copyCode()">ğŸ“‹ é»ä¸€ä¸‹è¤‡è£½å®Œæˆç¢¼</button>
    <button onclick="goBack()">è¿”å› BeClass</button>
  </div>
</div>

<script>
const BECLASS_URL = "https://www.beclass.com/rid=305025d6951ebb848db3";
const UPLOAD_URL = "https://script.google.com/macros/s/AKfycbxGiFJWxW0cGRF_CI4N0yx6MuveT7olzhqhMAp1SdQrv7sAxakGvmIF9tXSs_WqZ9Reaw/exec";

const canvas = document.getElementById("signaturePad");
const ctx = canvas.getContext("2d");
let drawing = false;
let currentCode = "";

ctx.lineWidth = 2;
ctx.lineCap = "round";
ctx.strokeStyle = "#000";

function getPos(e){
  const r = canvas.getBoundingClientRect();
  if (e.touches && e.touches[0]) {
    return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
  }
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

// mouse
canvas.addEventListener("mousedown", e => {
  drawing = true;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
});
canvas.addEventListener("mousemove", e => {
  if (!drawing) return;
  const p = getPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});
canvas.addEventListener("mouseup", () => drawing = false);
canvas.addEventListener("mouseleave", () => drawing = false);

// touch
canvas.addEventListener("touchstart", e => {
  drawing = true;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(p.x, p.y);
});
canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!drawing) return;
  const p = getPos(e);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
});
canvas.addEventListener("touchend", () => drawing = false);

function clearCanvas(){
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  currentCode = "";
  document.getElementById("codeBox").style.display = "none";
}

function isBlank(){
  const d = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
  for (let i = 3; i < d.length; i += 4) {
    if (d[i] !== 0) return false;
  }
  return true;
}

function nowStr(){
  const d = new Date(), p = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

function nowCompact(){
  const d = new Date(), p = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
}

async function sha256(text){
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

// å®Œæˆç°½å â†’ ç”¢ç”Ÿå®Œæˆç¢¼
async function saveSignature(){
  const agree = document.getElementById("agreeChk");
  if (agree && !agree.checked){
    alert("è«‹å…ˆå‹¾é¸åŒæ„äº‹é …");
    return;
  }
  if (isBlank()){
    alert("å°šæœªç°½åï¼Œè«‹å…ˆæ‰‹å¯«ç°½å");
    return;
  }

  const dataURL = canvas.toDataURL("image/png");
  const hash = (await sha256(dataURL)).slice(0,16);
  currentCode = `SIGNED|${nowStr()}|${hash}`;

  document.getElementById("signCodeOutput").textContent = currentCode;
  document.getElementById("codeBox").style.display = "block";
}

// ä¸Šå‚³åˆ° Google Driveï¼ˆno-corsï¼Œä¸è®€å›æ‡‰ï¼‰
async function uploadSignature(){
  const agree = document.getElementById("agreeChk");
  if (agree && !agree.checked){
    alert("è«‹å…ˆå‹¾é¸åŒæ„äº‹é …");
    return;
  }
  if (isBlank()){
    alert("å°šæœªç°½åï¼Œè«‹å…ˆæ‰‹å¯«ç°½å");
    return;
  }

  const emp = prompt("è«‹è¼¸å…¥å§“åï¼ˆå»ºè­°ï¼šå·¥è™Ÿ_å§“åï¼‰");
  if (!emp) return;

  const dataURL = canvas.toDataURL("image/png");
  const filename = `${emp}_${nowCompact()}.png`;

  // âœ… å¼·åˆ¶ POSTï¼šç”¨ form çš„ method å±¬æ€§èˆ‡ setAttribute é›™ä¿éšª
  const form = document.createElement("form");
  form.setAttribute("method", "POST");
  form.method = "POST";
  form.action = UPLOAD_URL;

  // æ¸¬è©¦ç”¨ï¼šå…ˆé–‹æ–°åˆ†é çœ‹å›æ‡‰ï¼ˆæˆåŠŸæ™‚æ‡‰å› OK:UPLOADED:xxxï¼‰
  form.target = "_blank";

  // âœ… å¾ˆé—œéµï¼šenctype ä¸è¦ç”¨ multipartï¼ˆApps Script WebApp ä¸åƒï¼‰
  form.enctype = "application/x-www-form-urlencoded";

  const i1 = document.createElement("input");
  i1.type = "hidden";
  i1.name = "imageBase64";
  i1.value = dataURL;

  const i2 = document.createElement("input");
  i2.type = "hidden";
  i2.name = "filename";
  i2.value = filename;

  // åŠ ä¸€å€‹å°åƒæ•¸ï¼Œæ–¹ä¾¿ä½ è¾¨è­˜æ˜¯ä¸æ˜¯ doPost æ”¶åˆ°
  const i3 = document.createElement("input");
  i3.type = "hidden";
  i3.name = "ping";
  i3.value = "1";

  form.appendChild(i1);
  form.appendChild(i2);
  form.appendChild(i3);

  document.body.appendChild(form);
  form.submit();
  form.remove();
}


async function copyCode(){
  if (!currentCode){
    alert("å°šæœªç”¢ç”Ÿå®Œæˆç¢¼");
    return;
  }
  await navigator.clipboard.writeText(currentCode);
  alert("å®Œæˆç¢¼å·²è¤‡è£½ï¼Œè«‹å› BeClass è²¼ä¸Š");
}

function goBack(){
  location.href = BECLASS_URL;
}
</script>



</body>
</html>

















